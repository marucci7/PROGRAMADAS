// Fun√ß√£o personalizada que ser√° executada ao editar a planilha
function onEditRequestStatus(e) {
    var sheet = e.source.getActiveSheet();
    var editedCell = e.range;
    
    // Verifica se a edi√ß√£o foi feita na coluna B (√≠ndice 2) e se o valor alterado √© "AGUARDANDO RETIRADA"
    if (editedCell.getColumn() == 2 && editedCell.getValue() == "AGUARDANDO RETIRADA") {
      var row = editedCell.getRow();
      
      // Obt√©m os emails dos aprovadores (colunas R e S)
      var email1 = sheet.getRange(row, 18).getValue();  // Coluna R (18)
      var email2 = sheet.getRange(row, 19).getValue();  // Coluna S (19)
      
      // Obt√©m as informa√ß√µes detalhadas da requisi√ß√£o
      var requisicao = sheet.getRange(row, 2).getValue();  // N√∫mero da Requisi√ß√£o (coluna B)
      var dataCriacao = sheet.getRange(row, 4).getValue();  // Data de Cria√ß√£o (coluna D)
      var centroCusto = sheet.getRange(row, 4).getValue();  // Centro de Custo (coluna E)
      var nomeSolicitante = sheet.getRange(row, 6).getValue();  // Nome do Solicitante (coluna F)
      var codigoMaterial = sheet.getRange(row, 7).getValue();  // C√≥digo do Material (coluna G)
      var localRetirada = sheet.getRange(row, 8).getValue();  // Local de Retirada (coluna H)
      var descricaoMaterial = sheet.getRange(row, 9).getValue();  // Descri√ß√£o do Material (coluna I)
      
      // Envia o primeiro e-mail com as informa√ß√µes detalhadas
      if (email1 || email2) {
        var subject = "Aprovador, a requisi√ß√£o est√° aguardando retirada";
        
        // Corpo do e-mail com emojis como √≠cones antes de cada t√≥pico
        var body = "Ol√°,\n\nA requisi√ß√£o de n√∫mero " + requisicao + " est√° aguardando retirada. Por favor, realizar a retirada ou informar o solicitante.\n\n" +
                   "Aqui est√£o os detalhes da requisi√ß√£o:\n\n" +
                   "üìÖ Data de Cria√ß√£o: " + dataCriacao + "\n" +
                   "üè∑Ô∏è Centro de Custo: " + centroCusto + "\n" +
                   "üë§ Nome do Solicitante: " + nomeSolicitante + "\n" +  // Nome do solicitante adicionado
                   "üî¢ C√≥digo do Material: " + codigoMaterial + "\n" +
                   "üìç Local de Retirada*: " + localRetirada + "\n" +
                   "üìù Descri√ß√£o do Material: " + descricaoMaterial + "\n\n" +
                   "Atenciosamente,\nAlmoxarifado Site";
        
        // Envia o e-mail para o primeiro aprovador
        if (email1) {
          MailApp.sendEmail(email1, subject, body);
        }
        
        // Envia o e-mail para o segundo aprovador, se houver
        if (email2) {
          MailApp.sendEmail(email2, subject, body);
        }
      }
      
      // Cria um gatilho de tempo para enviar lembretes a cada 3 horas
      ScriptApp.newTrigger("sendReminderEmails")
        .timeBased()
        .everyHours(3) // Envia a cada 3 horas
        .create();
    }
  
    // Verifica se a c√©lula foi alterada para "ENTREGUE AO SOLICITANTE"
    if (editedCell.getColumn() == 2 && editedCell.getValue() == "ENTREGUE AO SOLICITANTE") {
      // Apaga todos os gatilhos de lembretes para essa linha
      var triggers = ScriptApp.getProjectTriggers();
      for (var i = 0; i < triggers.length; i++) {
        if (triggers[i].getHandlerFunction() == "sendReminderEmails") {
          ScriptApp.deleteTrigger(triggers[i]);
        }
      }
    }
  }
  
  // Fun√ß√£o para enviar e-mail de lembrete e agendar mais envios
  function sendReminderEmails() {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var data = sheet.getDataRange().getValues();  // Obt√©m todos os dados da planilha
    
    // Loop atrav√©s das linhas da planilha
    for (var i = 0; i < data.length; i++) {
      var status = data[i][1]; // Status na coluna B (√≠ndice 1)
      var email1 = data[i][17]; // E-mail do aprovador 1 na coluna R (√≠ndice 17)
      var email2 = data[i][18]; // E-mail do aprovador 2 na coluna S (√≠ndice 18)
      var requisicao = data[i][2]; // N√∫mero da requisi√ß√£o na coluna C (√≠ndice 2)
      
      // Obt√©m as informa√ß√µes detalhadas da requisi√ß√£o
      var dataCriacao = data[i][3];  // Data de Cria√ß√£o (coluna D)
      var centroCusto = data[i][4];  // Centro de Custo (coluna C)
      var nomeSolicitante = data[i][5];  // Nome do Solicitante (coluna F)
      var codigoMaterial = data[i][6];  // C√≥digo do Material (coluna G)
      var localRetirada = data[i][7];  // Local de Retirada (coluna H)
      var descricaoMaterial = data[i][8];  // Descri√ß√£o do Material (coluna I)
      
      // Verifica se o status est√° "AGUARDANDO RETIRADA"
      if (status == "AGUARDANDO RETIRADA") {
        var subject = "Aprovador, a requisi√ß√£o est√° aguardando retirada";
        
        // Corpo do e-mail com emojis como √≠cones antes de cada t√≥pico
        var body = "Ol√°,\n\nA requisi√ß√£o de n√∫mero " + requisicao + " est√° aguardando retirada. Por favor, realizar a retirada ou informar o solicitante\n\n" +
                   "Aqui est√£o os detalhes da requisi√ß√£o:\n\n" +
                   "üìÖ Data de Cria√ß√£o: " + dataCriacao + "\n" +
                   "üè∑Ô∏è Centro de Custo: " + centroCusto + "\n" +
                   "üë§ Nome do Solicitante: " + nomeSolicitante + "\n" +  // Nome do solicitante adicionado
                   "üî¢ C√≥digo do Material: " + codigoMaterial + "\n" +
                   "üìç Local de Retirada: " + localRetirada + "\n" +
                   "üìù Descri√ß√£o do Material: " + descricaoMaterial + "\n\n" +
                   "Atenciosamente,\nAlmoxarifado";
        
        // Envia o e-mail para os aprovadores se houver e-mails v√°lidos
        if (email1) {
          MailApp.sendEmail(email1, subject, body);
        }
        if (email2) {
          MailApp.sendEmail(email2, subject, body);
        }
      }
    }
}

// AP√ìS A CHEGADA DO MATERIAL COMPRADO PROGRAMADO, SEPARAMOS O MATERIAL E AGUARDAMOS O APROVADOR FAZER SUA RETIRADA.
// PARA ISSO, DESENVOLVI ESSE SCRIPT, ONDE O VALOR DA C√âLULA NA COLUNA B FOR "AGUARDANDO RETIRADA", O APROVADOR RECEBER√Å UM EMAIL AUTOM√ÅTICO COM AS INFORMA√á√ïES DA REQUSI√á√ÉO.


